# TGV2RayScraper

TGV2RayScraper — это проект на Python, предназначенный для сбора данных из Telegram-каналов, извлечения и обработки конфигураций V2Ray, включая их очистку, нормализацию и удаление дубликатов. Проект поддерживает актуальную информацию о каналах и включает инструменты для управления их списками. Он предоставляет как синхронные, так и асинхронные инструменты для сбора данных и обработки конфигураций V2Ray.

Для английской версии смотрите [README.md](../../README.md)

---

## Быстрый старт

Следуйте этим шагам, чтобы быстро начать работу:

1. **Клонируем репозиторий**

```bash
git clone https://github.com/denxv/TGV2RayScraper.git
```

```bash
cd TGV2RayScraper
```

2. **Создаём и активируем виртуальное окружение**

* На Linux/macOS:

```bash
python -m venv venv
```

```bash
source venv/bin/activate
```

* На Windows:

```bash
python -m venv venv
```

```bash
venv\Scripts\activate
```

3. **Устанавливаем зависимости**

```bash
pip install -r requirements.txt
```

4. **Запускаем основной скрипт проекта**

```bash
python main.py
```

Это обновит список каналов, соберёт данные и очистит V2Ray-конфигурации за один запуск.

---

## Зависимости

Проект требует следующие библиотеки Python:

* **aiofiles** – асинхронная работа с файлами
* **asteval** — безопасная оценка Python-выражений (используется для фильтрации конфигураций)
* **httpx** — современный HTTP-клиент с поддержкой как синхронных, так и асинхронных запросов
* **lxml** – парсинг и обработка HTML/XML
* **tqdm** – индикатор прогресса для длительных операций

Другие зависимости перечислены в [`requirements.txt`](../../requirements.txt).

---

## Структура проекта

* **adapters/** — адаптеры для синхронной и асинхронной работы с данными
  * **async_/** — асинхронные реализации операций (каналы, конфигурации, скрейпинг)
    * `channels.py` — асинхронные операции с каналами
    * `configs.py` — асинхронная обработка конфигураций
    * `scraper.py` — асинхронный скрейпер данных с каналов
  * **sync/** — синхронные реализации операций
    * `channels.py` — синхронные операции с каналами
    * `configs.py` — синхронная обработка конфигураций
    * `scraper.py` — синхронный скрейпер данных с каналов

* **core/** — основные утилиты и константы
  * `constants.py` — константы, дефолтные пути, шаблоны URL, регулярные выражения, флаги скриптов
  * `decorators.py` — декораторы (например, для логирования)
  * `logger.py` — утилита для логирования с цветной консолью и микро-секундными метками
  * `typing.py` — собственные псевдонимы типов для проекта (каналы, V2Ray конфиги, CLI, сессии и т.д.)
  * `utils.py` — утилиты и вспомогательные функции

* **domain/** — бизнес-логика и доменные функции
  * `channel.py` — работа с каналами, сортировка, фильтрация
  * `config.py` — обработка и нормализация конфигураций
  * `predicates.py` — логика фильтрации и предикаты

* **main.py** — главный скрипт для выполнения всех операций проекта, включая обновление каналов, сбор данных и обработку конфигураций

* **requirements.txt** — список всех необходимых библиотек для запуска проекта

---

## Структура JSON файлов каналов

Файл `channels/current.json` хранит метаданные о каналах Telegram. Верхнеуровневые ключи — **имена каналов**, а значения — объекты с состоянием канала.

### Пример

```json
{
    "channel_new_default": {
        "count": 0,
        "current_id": 1,
        "last_id": -1
    },
    "channel_is_not_live": {
        "count": -1,
        "current_id": 100,
        "last_id": -1
    },
    "channel_live": {
        "count": 500,
        "current_id": 100,
        "last_id": 100
    },
    "channel_will_be_deleted": {
        "count": -3,
        "current_id": 100,
        "last_id": -1
    }
}
```

### Описание полей

* **`count`**
  * `> 0` → количество найденных V2Ray-конфигураций в активном канале (`count = 1`)
  * `= 0` → ничего не найдено или канал временно недоступен (`last_id = -1`)
  * `< 0` → количество неудачных попыток доступа к каналу
    * Каждая неудачная попытка уменьшает значение (`-1, -2, …`).
    * Когда `count <= -3`, канал считается неактивным и удаляется из `current.json` и `urls.txt`.

* **`current_id`**
  * ID текущего сообщения, с которого начинается сканирование
  * `1` → сканирование начинается с самого начала Telegram канала (старые сообщения)
  * отрицательное → взять последние N сообщений (новые сообщения)
    * Пример: если `last_id = 150` и `current_id = -100`, фактический `current_id` равен `150 - 100 = 50`. Сканирование начнётся с сообщения 50 и продвигается к последнему сообщению (`last_id = 150`).

* **`last_id`**
  * ID последнего сообщения в канале
  * обновляется при каждом запуске
  * `-1` → канал временно или навсегда недоступен
  * в остальных случаях — положительное число

---

## Поддерживаемые протоколы

Файл с очищенными конфигурациями (`configs/v2ray-clean.txt`) содержит записи в одном из следующих форматов:

---

### **AnyTLS**

```text
anytls://password@host:port/path?params#name
anytls://password@host:port?params#name
```

---

### **Hy2 / Hysteria2**

```text
hy2://password@host:port/path?params#name
hy2://password@host:port?params#name
hysteria2://password@host:port/path?params#name
hysteria2://password@host:port?params#name
```

---

### **Shadowsocks / ShadowsocksR**

```text
ss://base64(method:password)@host:port#name
ss://method:password@host:port#name
ss://base64(method:password@host:port)#name
ssr://base64(host:port:protocol:method:obfs:base64(password)/?param=base64(value))
```

---

### **Trojan**

```text
trojan://password@host:port/path?params#name
trojan://password@host:port?params#name
```

---

### **TUIC**

```text
tuic://uuid:password@host:port/path?params#name
tuic://uuid:password@host:port?params#name
```

---

### **VLESS**

```text
vless://uuid@host:port/path?params#name
vless://uuid@host:port?params#name
```

---

### **VMess**

```text
vmess://base64(json)
vmess://uuid@host:port/path?params#name
vmess://uuid@host:port?params#name
```

---

### **WireGuard**

```text
wireguard://privatekey@host:port/path?params#name
wireguard://privatekey@host:port?params#name
```

---

## Использование

---

### **1. Обновление каналов**

Вы можете запустить скрипт обновления каналов следующим образом:

```bash
python -m scripts.update_channels
```

Также доступен альтернативный способ запуска с использованием `PYTHONPATH`:

```bash
PYTHONPATH=. python scripts/update_channels.py
```

Можно использовать `-h`, чтобы увидеть все доступные опции:

```bash
python -m scripts.update_channels -h
```

**Опции:**

* `--no-dry-run` — Отключить режим проверки и фактически присвоить `current_id` (по умолчанию отключено).
* `-C, --channels FILE` — Путь к входному JSON-файлу со списком каналов (по умолчанию: `channels/current.json`).
* `-D, --delete-channels` — Удалять каналы, которые недоступны или соответствуют определённым условиям (по умолчанию отключено).
* `-M, --message-offset N` — Количество последних сообщений, учитываемых при присвоении `current_id`.
* `-N, --include-new` — Включать новые каналы в обработку.
* `-U, --urls FILE` — Путь к текстовому файлу с новыми URL каналов (по умолчанию: `channels/urls.txt`).

---

Скрипт:

* Читает текущий список каналов из `channels/current.json`.
* Объединяет с новыми URL из `channels/urls.txt`.
* По умолчанию выполняется проверка без внесения изменений (`--no-dry-run` отключает её).
* Позволяет присвоить `current_id` каналам с учётом смещения сообщений (`--message-offset`).
* Может включать новые каналы в обработку (`--include-new`).
* Поддерживает удаление недоступных или помеченных каналов (`--delete-channels`).
* Создаёт резервные копии обоих файлов с меткой времени.
* Сохраняет обновлённый список обратно в `current.json` и `urls.txt`.
* Ведёт подробный лог предупреждений и debug-информацию для каждого канала.

---

**Пример использования:**

```bash
python -m scripts.update_channels -C channels/current.json -U channels/urls.txt -D -M 50 -N --no-dry-run
```

---

### **2. Запуск скраперов**

#### **Асинхронный скрапер** (быстрее, экспериментальный)

Вы можете запустить асинхронный скрапер следующим образом:

```bash
python -m scripts.async_scraper
```

Также доступен альтернативный способ запуска с использованием `PYTHONPATH`:

```bash
PYTHONPATH=. python scripts/async_scraper.py
```

Можно использовать `-h`, чтобы увидеть все доступные опции:

```bash
python -m scripts.async_scraper -h
```

**Опции:**

* `-C, --channels FILE` — Путь к входному JSON-файлу со списком каналов (по умолчанию: `channels/current.json`).
* `-E, --batch-extract N` — Количество сообщений, обрабатываемых параллельно для извлечения V2Ray конфигураций (по умолчанию: 20).
* `-R, --configs-raw FILE` — Путь к выходному файлу для сохранения собранных V2Ray конфигураций (по умолчанию: `configs/v2ray-raw.txt`).
* `-U, --batch-update N` — Максимальное количество каналов, обновляемых параллельно (по умолчанию: 100).

---

**Пример использования:**

```bash
python -m scripts.async_scraper -E 20 -U 100 -C channels/current.json -R configs/v2ray-raw.txt
```

---

#### **Синхронный скрапер** (проще, медленнее)

Вы можете запустить синхронный скрапер следующим образом:

```bash
python -m scripts.scraper
```

Также доступен альтернативный способ запуска с использованием `PYTHONPATH`:

```bash
PYTHONPATH=. python scripts/scraper.py
```

Можно использовать `-h`, чтобы увидеть все доступные опции:

```bash
python -m scripts.scraper -h
```

**Опции:**

* `-C, --channels FILE` — Путь к входному JSON-файлу со списком каналов (по умолчанию: `channels/current.json`).
* `-R, --configs-raw FILE` — Путь к выходному файлу для сохранения собранных V2Ray конфигураций (по умолчанию: `configs/v2ray-raw.txt`).

---

**Пример использования:**

```bash
python -m scripts.scraper -C channels/current.json -R configs/v2ray-raw.txt
```

---

### **3. Очистка конфигураций V2Ray**

Вы можете запустить скрипт очистки конфигураций V2Ray следующим образом:

```bash
python -m scripts.v2ray_cleaner
```

Также доступен альтернативный способ запуска с использованием `PYTHONPATH`:

```bash
PYTHONPATH=. python scripts/v2ray_cleaner.py
```

Можно использовать `-h`, чтобы увидеть все доступные опции:

```bash
python -m scripts.v2ray_cleaner -h
```

**Опции:**

* `-D, --duplicate [FIELDS]` — Удалить дубликаты по указанным полям через запятую. Если указано без значения (например, `-D`), по умолчанию используются `protocol,host,port`. Если не указано, дубликаты не удаляются.
* `-F, --filter CONDITION` — Фильтровать записи с использованием Python-подобного условия. Пример: `"host == '1.1.1.1' and port > 1000"`. Сохраняются только подходящие записи.
* `-I, --configs-raw FILE` — Путь к входному файлу с сырыми V2Ray конфигурациями (по умолчанию: `configs/v2ray-raw.txt`).
* `-N, --no-normalize` — Отключить нормализацию (по умолчанию включена).
* `-O, --configs-clean FILE` — Путь к выходному файлу для очищенных и обработанных конфигураций (по умолчанию: `configs/v2ray-clean.txt`).
* `-R, --reverse` — Сортировать записи в порядке убывания (только при использовании `--sort`).
* `-S, --sort [FIELDS]` — Сортировать записи по указанным полям через запятую. Если указано без значения (например, `-S`), используются поля `host,port`. Если не указано, сортировка не применяется.

---

Скрипт:

* Читает сырые конфигурации из `configs/v2ray-raw.txt`.
* Применяет фильтры на основе регулярных выражений и нормализацию.
* Удаляет дубликаты (если используется `--duplicate`).
* Сортирует записи (если используется `--sort`).
* Сохраняет очищенные и обработанные конфигурации в `configs/v2ray-clean.txt`.

---

**Пример использования:**

```bash
python -m scripts.v2ray_cleaner -I configs/v2ray-raw.txt -O configs/v2ray-clean.txt --filter "re_search(r'speedtest|google', host)" -D "host, port" -S "protocol, host, port" --reverse
```

---

### **4. Запуск всех операций через `main.py`**

```bash
python main.py
```

Вы также можете использовать `-h` или `--help-scripts`, чтобы увидеть все доступные опции:

```bash
python main.py -h
```

```bash
python main.py --help-scripts
```

**Опции:**

* `-H, --help-scripts` — Показать справку по всем внутренним скриптам pipeline.
* `-N, --no-async` — Использовать более медленный, но простой синхронный режим сбора данных вместо стандартного асинхронного.

---

Скрипт:

* Выполняет все этапы pipeline в порядке:

  1. `update_channels.py` – обновляет список каналов.
  2. `async_scraper.py` – собирает данные каналов из Telegram асинхронно (быстрее, используется по умолчанию).
  3. `scraper.py` – собирает данные каналов синхронно, если используется `--no-async` (медленнее, проще).
  4. `v2ray_cleaner.py` – очищает, нормализует и обрабатывает полученные прокси-конфигурации.

* Автоматически передаёт каждому скрипту только релевантные аргументы.

---

**Пример использования:**

```bash
python main.py --batch-extract 10 --batch-update 100 --filter "host and port" --duplicate --sort "protocol" --reverse
```

---

## Примечания

* Всегда обновляйте список каналов перед запуском скраперов.
* Используйте очистку V2Ray после скрапинга для нормализации конфигураций.
* Скрипты предоставляются **как есть**; используйте их на свой страх и риск.

---

## Отказ от ответственности

Это программное обеспечение предоставляется «как есть». Автор **не несёт ответственности** за любой ущерб, потерю данных или другие последствия, возникшие в результате использования этого ПО.

**Важно:** предназначено только для образовательного или личного использования. Автор не несёт ответственности за:

* Неправомерное использование, включая спам или перегрузку серверов Telegram
* Несанкционированный сбор данных
* Юридические или финансовые последствия

Используйте ответственно и соблюдайте правила платформы.

---

## Лицензия

Этот проект лицензирован под MIT License – см. файл [LICENSE](LICENSE) для деталей.
