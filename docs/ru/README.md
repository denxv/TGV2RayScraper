# TGV2RayScraper

TGV2RayScraper — это проект на Python, предназначенный для сбора данных из каналов Telegram, извлечения конфигураций V2Ray и их обработки путем очистки, нормализации и удаления дубликатов, при этом поддерживается актуальная информация о каналах. Проект поддерживает как синхронный, так и асинхронный сбор данных и включает инструменты для управления списками каналов.

Для английской версии смотрите [README.md](../../README.md)

---

## Быстрый старт

Следуйте этим шагам, чтобы быстро начать работу:

1. **Клонируем репозиторий**

```bash
git clone https://github.com/denxv/TGV2RayScraper.git
```

```bash
cd TGV2RayScraper
```

2. **Создаём и активируем виртуальное окружение**

* На Linux/macOS:

```bash
python -m venv venv
```

```bash
source venv/bin/activate
```

* На Windows:

```bash
python -m venv venv
```

```bash
venv\Scripts\activate
```

3. **Устанавливаем зависимости**

```bash
pip install -r requirements.txt
```

4. **Запускаем основной скрипт проекта**

```bash
python main.py
```

Это обновит список каналов, соберёт данные и очистит V2Ray-конфигурации за один запуск.

---

## Зависимости

Проект требует следующие библиотеки Python:

* **aiohttp** – асинхронный HTTP-клиент
* **aiofiles** – асинхронная работа с файлами
* **asteval** — безопасная оценка Python-выражений (используется для фильтрации конфигураций)
* **lxml** – парсинг и обработка HTML/XML
* **requests** – синхронный HTTP-клиент
* **tqdm** – индикатор прогресса для длительных операций

Другие зависимости перечислены в [`requirements.txt`](../../requirements.txt).

---

## Структура проекта

* **channels/** – хранение данных каналов

  * `current.json` – JSON-файл с актуальными данными каналов
  * `urls.txt` – текстовый файл с URL-адресами Telegram-каналов

* **scripts/** – скрипты для обработки данных

  * `async_scraper.py` – асинхронный сбор данных с каналов Telegram
  * `scraper.py` – синхронный сбор данных с каналов Telegram
  * `update_channels.py` – обновление списка каналов
  * `v2ray_cleaner.py` – утилита для обработки конфигураций V2Ray и других прокси: очистка, нормализация, фильтрация, удаление дубликатов и сортировка

* **v2ray/** – хранение V2Ray-конфигураций

  * `configs-clean.txt` – очищенные, нормализованные, отфильтрованные и без дубликатов конфигурации
  * `configs-raw.txt` – сырые конфигурации прокси, собранные из разных источников

* **requirements.txt** — список всех библиотек Python, необходимых для работы проекта

* **main.py** — основной скрипт для запуска всех операций проекта, включая обновление каналов, сбор данных и обработку конфигураций прокси

---

## Структура JSON файлов каналов

Файл `channels/current.json` хранит метаданные о каналах Telegram. Верхнеуровневые ключи — **имена каналов**, а значения — объекты с состоянием канала.

### Пример

```json
{
    "channel_new_default": {
        "count": 0,
        "current_id": 1,
        "last_id": -1
    },
    "channel_is_not_live": {
        "count": -1,
        "current_id": 100,
        "last_id": -1
    },
    "channel_live": {
        "count": 500,
        "current_id": 100,
        "last_id": 100
    },
    "channel_will_be_deleted": {
        "count": -3,
        "current_id": 100,
        "last_id": -1
    }
}
```

### Описание полей

* **`count`**

  * `> 0` → количество найденных V2Ray-конфигураций в активном канале (`count = 1`)
  * `= 0` → ничего не найдено или канал временно недоступен (`last_id = -1`)
  * `< 0` → количество неудачных попыток доступа к каналу

    * Каждая неудачная попытка уменьшает значение (`-1, -2, …`).
    * Когда `count <= -3`, канал считается неактивным и удаляется из `current.json` и `urls.txt`.

* **`current_id`**

  * ID текущего сообщения, с которого начинается сканирование
  * `1` → сканирование начинается с самого начала Telegram канала (старые сообщения)
  * отрицательное → взять последние N сообщений (новые сообщения)

    * Пример: если `last_id = 150` и `current_id = -100`, фактический `current_id` равен `150 - 100 = 50`. Сканирование начнётся с сообщения 50 и продвигается к последнему сообщению (`last_id = 150`).

* **`last_id`**

  * ID последнего сообщения в канале
  * обновляется при каждом запуске
  * `-1` → канал временно или навсегда недоступен
  * в остальных случаях — положительное число

---

## Поддерживаемые протоколы

Файл с очищенными конфигурациями (`v2ray/configs-clean.txt`) содержит записи в одном из следующих форматов:

---

### **AnyTLS**

```text
anytls://password@host:port/path?params#name
anytls://password@host:port?params#name
```

---

### **Hy2 / Hysteria2**

```text
hy2://password@host:port/path?params#name
hy2://password@host:port?params#name
hysteria2://password@host:port/path?params#name
hysteria2://password@host:port?params#name
```

---

### **Shadowsocks / ShadowsocksR**

```text
ss://base64(method:password)@host:port#name
ss://method:password@host:port#name
ss://base64(method:password@host:port)#name
ssr://base64(host:port:protocol:method:obfs:base64(password)/?param=base64(value))
```

---

### **Trojan**

```text
trojan://password@host:port/path?params#name
trojan://password@host:port?params#name
```

---

### **TUIC**

```text
tuic://uuid:password@host:port/path?params#name
tuic://uuid:password@host:port?params#name
```

---

### **VLESS**

```text
vless://uuid@host:port/path?params#name
vless://uuid@host:port?params#name
```

---

### **VMess**

```text
vmess://base64(json)
vmess://uuid@host:port/path?params#name
vmess://uuid@host:port?params#name
```

---

### **WireGuard**

```text
wireguard://privatekey@host:port/path?params#name
wireguard://privatekey@host:port?params#name
```

---

## Использование

---

### **1. Обновление каналов**

```bash
python scripts/update_channels.py
```

Можно также использовать `-h`, чтобы увидеть все доступные опции:

```bash
python scripts/update_channels.py -h
```

**Опции:**

* `-C, --channels FILE` — путь к текущему JSON-файлу каналов (по умолчанию: `channels/current.json`).
* `-U, --urls FILE` — путь к текстовому файлу с URL новых каналов (по умолчанию: `channels/urls.txt`).

---

Скрипт:

* Читает текущий список каналов (`channels/current.json`)
* Объединяет с новыми URL из `channels/urls.txt`
* Создаёт резервные копии обоих файлов с меткой времени
* Сохраняет обновлённый список обратно в `current.json` и `urls.txt`

---

### **2. Запуск скраперов**

* **Асинхронный скрапер** (быстрее, экспериментальный)

```bash
python scripts/async_scraper.py
```

Можно использовать `-h` для просмотра всех опций:

```bash
python scripts/async_scraper.py -h
```

**Опции:**

* `-C, --channels FILE` — путь к текущему JSON-файлу каналов (по умолчанию: `channels/current.json`).
* `-E, --batch-extract N` — количество одновременно обрабатываемых страниц для извлечения конфигураций V2Ray (по умолчанию: 20).
* `-O, --output FILE` — путь для сохранения собранных конфигураций V2Ray (по умолчанию: `v2ray/configs-raw.txt`).
* `-U, --batch-update N` — максимальное количество каналов для одновременного обновления информации (по умолчанию: 100).

---

* **Синхронный скрапер** (проще, медленнее)

```bash
python scripts/scraper.py
```

Можно использовать `-h` для просмотра всех опций:

```bash
python scripts/scraper.py -h
```

**Опции:**

* `-C, --channels FILE` — путь к текущему JSON-файлу каналов (по умолчанию: `channels/current.json`).
* `-O, --output FILE` — путь для сохранения собранных конфигураций V2Ray (по умолчанию: `v2ray/configs-raw.txt`).

---

### **3. Очистка конфигураций V2Ray**

```bash
python scripts/v2ray_cleaner.py
```

Можно использовать `-h`, чтобы увидеть все опции:

```bash
python scripts/v2ray_cleaner.py -h
```

**Опции:**

* `-D, --duplicate [FIELDS]` — удалить дубликаты по указанным полям через запятую. Если указано без значения (например, `-D`), по умолчанию используются `protocol,host,port`. Если не указано, дубликаты не удаляются.
* `-F, --filter CONDITION` — фильтровать записи с использованием Python-подобного условия. Пример: `"host == '1.1.1.1' and port > 1000"`. Сохраняются только подходящие записи.
* `-I, --input FILE` — путь к файлу с сырыми конфигурациями (по умолчанию: `v2ray/configs-raw.txt`).
* `-N, --no-normalize` — отключить нормализацию (по умолчанию включена).
* `-O, --output FILE` — путь для сохранения очищенных и обработанных конфигураций (по умолчанию: `v2ray/configs-clean.txt`).
* `-R, --reverse` — сортировать записи в порядке убывания (только при использовании `--sort`).
* `-S, --sort [FIELDS]` — сортировать записи по указанным полям через запятую. Если указано без значения (например, `-S`), используются поля `host,port`. Если не указано, сортировка не применяется.

---

Скрипт:

* Читает сырые конфигурации из `v2ray/configs-raw.txt`.
* Применяет фильтры на основе регулярных выражений и нормализацию.
* Удаляет дубликаты (если используется `--duplicate`).
* Сортирует записи (если используется `--sort`).
* Сохраняет очищенные и обработанные конфигурации в `v2ray/configs-clean.txt`.

---

**Пример использования:**

```bash
python scripts/v2ray_cleaner.py --filter "host == '1.1.1.1'" --duplicate --sort
```

---

### **4. Запуск всех операций через `main.py`**

```bash
python main.py
```

---

Выполняет скрипты в следующем порядке:

1. `update_channels.py` — обновляет список каналов
2. `async_scraper.py` — асинхронно собирает данные с каналов Telegram
3. `v2ray_cleaner.py` — очищает, нормализует и обрабатывает конфигурации прокси

Позволяет обновлять каналы, собирать данные и очищать конфигурации за один шаг.

---

## Примечания

* Всегда обновляйте список каналов перед запуском скраперов.
* Используйте очистку V2Ray после скрапинга для нормализации конфигураций.
* Скрипты предоставляются **как есть**; используйте их на свой страх и риск.

---

## Отказ от ответственности

Это программное обеспечение предоставляется «как есть». Автор **не несёт ответственности** за любой ущерб, потерю данных или другие последствия, возникшие в результате использования этого ПО.

**Важно:** предназначено только для образовательного или личного использования. Автор не несёт ответственности за:

* Неправомерное использование, включая спам или перегрузку серверов Telegram
* Несанкционированный сбор данных
* Юридические или финансовые последствия

Используйте ответственно и соблюдайте правила платформы.

---

## Лицензия

Этот проект лицензирован под MIT License – см. файл [LICENSE](LICENSE) для деталей.
